{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "title: \"Correlation, Homogeneity and Dependency\"\n",
        "format: \n",
        "  html:\n",
        "    incremental: true\n",
        "    callout-icon: false\n",
        "    theme: [default, ../custom.scss]\n",
        "smaller: true\n",
        "css: ../style.css\n",
        "#filters:\n",
        "  #- parse-latex\n",
        "---\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "# Correlation Test\n",
        "\n",
        "::: {.callout}\n",
        "\n",
        "- We observe iid paired data $(X_1, Y_1), \\dots, (X_n,Y_n)$ of **unknown** mean $\\mu_X, \\mu_Y$ and cov matrix $\\Sigma$.\n",
        "- Cov matrix: \n",
        "$\\Sigma = \n",
        "\\left(\\begin{matrix} \n",
        "\\sigma_X^2 & \\mathrm{Cov(X,Y)} \\\\\n",
        "\\mathrm{Cov(X,Y)} & \\sigma_Y^2 \\\\\n",
        "\\end{matrix}\\right)$\n",
        "- $H_0: \\mathrm{Cov}(X,Y)=0$ or $H_1: \\mathrm{Cov}(X,Y)\\neq 0$ \n",
        "\n",
        "- $\\mathrm{Cov(X,Y)} = \\mathbb E[(X- \\mathbb E[X])^2]$\n",
        "- $\\sigma_X^2 = \\mathrm{Cov(X,X)}$\n",
        "- $\\sigma_Y^2 = \\mathrm{Cov(Y,Y)}$\n",
        "- $\\mathrm{Cor(X,Y)} = \\frac{\\mathrm{Cov(X,Y)}}{\\sigma_X \\sigma_Y}$\n",
        "\n",
        ":::\n",
        "\n",
        "::: {.callout-note .fragment}\n",
        "## Pearson's Correlation Test\n",
        "\n",
        "- $r =  \\frac{\\sum_{i=1}^n (X_i - \\overline X)(Y_i - \\overline Y)}{\\sqrt{\\sum_{i=1}^n (X_i - \\overline X)^2\\sum_{i=1}^n (Y_i - \\overline Y)^2}}$\n",
        "\n",
        "- $\\psi(X,Y) = \\frac{r}{\\sqrt{1-r^2}}\\sqrt{n-2}$\n",
        "- Under $H_0$, $\\psi(X,Y) \\approx \\mathcal T(n-2)$\n",
        ":::\n",
        "\n",
        "\n",
        "![](../images/correlated_X_Y.svg)\n",
        "\n",
        "\n",
        "\n",
        "## Correlation Test\n",
        "\n",
        "Monte Carlo Simulation with $n=4$:\n",
        "\n",
        "![](../images/correlation_pearson.png)\n",
        "\n",
        "## ANOVA Test\n",
        "\n",
        "::: {.callout .fragment}\n",
        "- $d$ independent groups (bags), each containing $N_1, \\dots, N_d$ individuals. $N_{\\mathrm{tot}} = \\sum_{k=1}^d N_k$\n",
        "- Group $k$: $(X_{1,k}, \\dots, X_{N_k,k}) \\in \\mathbb R^{N_k}$ are iid $\\mathcal N(\\mu_k, \\sigma)$. Ex: $X_{ik} =$ sallary of $i$ living in region $k$\n",
        "- $H_0: \\mu_1 = \\dots = \\mu_d$ vs $H_1: \\mu_l \\neq \\mu_k$ for some $(l,k)$ (**unknown $\\sigma$**)\n",
        ":::\n",
        "\n",
        "::: {.callout-note .fragment}\n",
        "## ANOVA\n",
        "\n",
        "- Empirical mean of group $k$:\n",
        "$\\overline X_k = \\tfrac{1}{N_k}\\sum_{i=1}^{N_k} X_{ik}$\n",
        "- Sum of Squares in group $k$: \\\n",
        "$SS_k = \\sum_{i=1}^{N_k} (X_{ik} - \\overline X_k)^2 \\sim \\sigma^2\\chi^2(N_k-1)$ (under $H_0$)\n",
        "- Var of group $k$: $V_k = \\tfrac{1}{N_k}SS_k$\n",
        "\n",
        "\n",
        "\n",
        "- Total empirical mean:\n",
        "$\\overline X = \\tfrac{1}{N_{\\mathrm{tot}}}\\sum_{k=1}^d\\sum_{i=1}^{N_k} X_{ik}$\n",
        "- Sum of Squares btween Groups: $SSB = \\sum_{k=1}^{d} N_k(\\overline X_k - \\overline X)^2\\sim\\sigma^2\\chi^2(d-1)$ (under $H_0$)\n",
        ":::\n",
        "\n",
        "![](../images/anova.svg)\n",
        "\n",
        "::: {.callout-note}\n",
        "## ANOVA Test Statistic\n",
        "- $\\psi(X) = \\frac{\\tfrac{1}{N_{\\mathrm{tot}} - d}\\sum_{k=1}^d SS_k}{\\tfrac{1}{d-1}SSB}$\n",
        "- $\\psi(X) \\sim \\mathcal F(N_{\\mathrm{tot}}-d, d-1)$ (Fisher under $H_0$)\n",
        "- Two-sided test: double the min left/right $p_{value}$.\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "# $\\chi^2$ Homogeneity and Independence Tests\n",
        "\n",
        "## $\\chi^2$ Homogeneity Test\n",
        "\n",
        "- $d$ different bags (or groups), each containing balls of $m$ potential colors.\n",
        "- If $d = 3$ and $m=2$, we observe the following $2\\times 3$ matrix of **counts**:\n",
        "\n",
        ":::{.fragment}\n",
        "|         | bag 1    | bag 2    | bag 3    | Total |\n",
        "| ------- | -------- | -------- | -------- | ----- |\n",
        "| color 1 | $X_{11}$ | $X_{12}$ | $X_{13}$ | $R_1$ |\n",
        "| color 2 | $X_{21}$ | $X_{22}$ | $X_{23}$ | $R_2$ |\n",
        "| Total   | $N_1$    | $N_2$    | $N_3$    | $N$   |\n",
        ":::\n",
        "\n",
        "\n",
        ":::{.callout}\n",
        "- Bag $j$: $(X_{1j}, X_{2j}) \\sim \\mathrm{Mult}(N_j, (p_{1j}, p_{2j}))$\n",
        "- The parameters $p_{ij}$ are **unknown**\n",
        "- $H_0$: $p_{i1} = p_{i2}=p_{i3}$ for all color $i$ (bags are homogeneous)\n",
        "- $H_1$: bags are heterogeneous\n",
        "- $\\sum_{i=1}^m\\sum_{j=1}^d \\frac{(X_{ij}- N_jp_{ij})^2}{N_jp_{ij}}$ **not a test statistic**\n",
        ":::\n",
        "\n",
        "\n",
        ":::{.callout-note}\n",
        "## Chi-Squared Homogeneity Test Statistic\n",
        "- $\\hat p_{i} = \\tfrac{1}{N}\\sum_{j=1}^{d}X_{ij} = \\frac{R_i}{N}$\n",
        "- $\\psi(X) = \\sum_{i=1}^m\\sum_{j=1}^d \\frac{(X_{ij}- N_j\\hat p_{i})^2}{N_j\\hat p_{i}}$\n",
        "- Approximation: $\\psi(X) \\sim \\chi^2((m-1)(d-1))$\n",
        ":::\n",
        "\n",
        "\n",
        "## Example: Soft drink preferences\n",
        "\n",
        "\n",
        "\n",
        "- Split population into $3$ categories: **Young Adults (18-30)**, **Middle-Aged Adults (31-50)**, and **Seniors (51 and above)**.\n",
        "- $H_0$: The groups are homogeneous in terms of soft drink preferences\n",
        "\n",
        "\n",
        "| Age Group    | Young Adults |  Middle-Aged | Seniors | Total |\n",
        "| ------------ | ---- | ----- | ------ | ----- |\n",
        "| Coke | 60   | 40    | 30     | 130   |\n",
        "| Pepsi  | 50   | 55    | 25     | 130   |\n",
        "| Sprite  | 30   | 45    | 55     | 130   |\n",
        "| **Total**    | 140  | 140   | 110    | 390   |\n",
        "\n",
        "\n",
        "- $N_1 \\hat p_1 = 140*\\frac{130}{390} \\approx 46.7$\n",
        "\n",
        "\n",
        "$$\n",
        "\\begin{aligned}\n",
        "\\psi(X) &= \\frac{(60-46.7)^2}{46.7}&+ \\frac{(40-46.7)^2}{46.7}&+\\frac{(30-36.7)^2}{36.7} \\\\\n",
        " &+\\frac{(50-46.7)^2}{46.7}&+ \\frac{(55-46.7)^2}{46.7}&+\\frac{(25-36.7)^2}{36.7}\\\\\n",
        " &+\\frac{(30-46.7)^2}{46.7}&+ \\frac{(45-46.7)^2}{46.7}&+\\frac{(55-36.7)^2}{36.7}\\\\\n",
        " \t&\\approx 26.57\n",
        "\\end{aligned}\n",
        "$$\n",
        "\n",
        "\n",
        "\n",
        "```julia\n",
        "1-cdf(Chisq(4), 26.57) # 2.4e-5, reject H_0\n",
        "```\n",
        "\n",
        "## $\\chi^2$ Independence Test\n",
        "\n",
        "::: {.callout}\n",
        "\n",
        "- Observations: Paired **Categorical** Variables $(X_1, Y_1), \\dots, (X_n, Y_n)$\n",
        "- e.g. $X_i \\in \\{\\mathrm{male}, \\mathrm{female}\\}$, $Y_i \\in \\{\\mathrm{coffee}, \\mathrm{tea}\\}$\n",
        "- Idea: regroup the data into bags, e.g. $\\{\\mathrm{male}, \\mathrm{female}\\}$\n",
        "- Build the contingency table\n",
        "- Perform a chi-square homogeneity test\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "Example of **contingency table**:\n",
        "\n",
        "|Gender|\tMale| Female|\tTotal|\n",
        "|--|--|--|--|\n",
        "|Coffee|\t30|\t20|\t50|\n",
        "|Tea|\t28\t|22\t|50|\n",
        "|Total|\t58|\t42|100|\n",
        "\n",
        "**Expected counts**:\n",
        "\n",
        "|Gender|\tMale| Female|\tTotal|\n",
        "|--|--|--|--|\n",
        "|Coffee|\t29|\t21|\t50|\n",
        "|Tea|\t29\t|21\t|50|\n",
        "|Total|\t58|\t42|100|\n",
        "\n",
        "\n",
        "- Degree of freedom: $(2-1)(2-1) = 1$\n",
        "\n",
        "# Wilcoxon's Signed Rank\n",
        "\n",
        "## Symetric Random Variable\n",
        "\n",
        ":::{.callout-note appearance=\"minimal\"}\n",
        "- A median of $X$ is a $0.5$-quantile of its distribution\n",
        "- If $X$ has density $p$, the median $m$ is such that\n",
        "$$\n",
        "\\int_{-\\infty}^m p(x)dx = \\int_{m}^{+\\infty} p(x)dx =  0.5 \\; .\n",
        "$$\n",
        "- A **symmetric** random variable $X$ is such that the distribution of $X$ is the same as the distribution of $-X$.\n",
        "- In particular, its median is $0$.\n",
        "- If $X$ is a **symmetric** random variable, then it has the same distribution as $\\varepsilon |X|$ where $\\varepsilon$ is independent of $X$ and uniformly distributed in $\\{-1,1\\}$\n",
        ":::\n",
        "\n",
        "::: {.fragment}\n",
        "::: {.callout-note}\n",
        "## Symetrization\n",
        "- If $X$ and $Y$ are two **independent** variables with same density $p$, then $X-Y$ is symetric.\n",
        "- Indeed:\n",
        "$$\n",
        "\\begin{aligned}\n",
        "\\mathbb P(X - Y \\leq t) \n",
        "&=\\int_{-\\infty}^t \\mathbb P(X \\leq t+y)p(y)dy \\\\\n",
        "&=\\int_{-\\infty}^t \\mathbb P(Y \\leq t+x)p(x)dy \\\\\n",
        "&= \\mathbb P(Y-X \\leq t) \\; .\n",
        "\\end{aligned}\n",
        "$$\n",
        "- $X$ indep of $Y$ $\\implies$ $X-Y$ symmetric $\\implies$ $\\mathrm{median}(X-Y) = 0$\n",
        ":::\n",
        ":::\n",
        "\n",
        "## Dependency Problem for Paired Data\n",
        "\n",
        ":::{.callout-note appearance=\"minimal\"}\n",
        "- We observe iid pairs of real numbers $(X_1, Y_1), \\dots, (X_n, Y_n)$. The density of each pair $(X_i, Y_i)$  is **unknown** $p_{XY}(x,y)$.\n",
        "\n",
        "- The marginal distribution of $X_i$ and $Y_i$ are, respectively,\n",
        "$$p_X(x) = \\int_{y \\in \\mathbb R} p_{XY}(x,y)~~~~ \\text{ and }~~~~ p_{Y}(y) = \\int_{x \\in \\mathbb R} p_{XY}(x,y) \\; .$$\n",
        "- $H_0:$ The median of $(X_i - Y_i)$ is $0$ for all $i$\n",
        "- $H_1:$ The median of  $(X_i - Y_i)$ is not $0$ for some $i$\n",
        ":::\n",
        "\n",
        "::: {.callout-note .fragment}\n",
        "## Generality of $H_0$\n",
        "- If $X_i-Y_i$ is symmetric $i$, then we are under $H_0$.\n",
        "- If $X_i$ is independent of $Y_i$ for all $i$, then we are under $H_0$.\n",
        ":::\n",
        ":::{.callout-warning .fragment}\n",
        "- The pairs are assume to be independent, but within each pair, $Y_i$ **can depend on** $X_i$ \n",
        "  (that is, we don't necessarily have $p(x,y) =p_X(x)p_Y(y)$).\n",
        ":::\n",
        "\n",
        "\n",
        "## Wilcoxon's Signed Rank Test\n",
        "\n",
        "\n",
        ":::{.callout appearance=\"minimal\"}\n",
        "- $D_i = X_i - Y_i$\n",
        "- We define the **sign** of pair $i$ as the sign of $D_i=X_i - Y_i$. It is in $\\{-1, 1\\}$.\n",
        "- We define the **rank** of pair $i$ as the permutation $R_i$ that satisfies $|D_{R_i}| = |D_{(i)}|$, where\n",
        "$$\n",
        "|D_{(1)}| \\leq  \\dots \\leq |D_{(n)}| \n",
        "$$\n",
        ":::\n",
        "\n",
        "\n",
        ":::{.callout-note .fragment}\n",
        "## Properties on the Signed Ranks \n",
        "Under $H_0$, \n",
        "\n",
        "- Signs of the $(D_i)$'s are independent and **uniformly distributed** in $\\{-1, 1\\}$. \n",
        "- In particular, the number of signs equal to $+1$ follows a Binomial distribution $\\mathcal B(n,0.5)$.\n",
        "- The ranks $R_i$ of the $(|D_i|)$'s does not depend on the **unknown** density $p_{X-Y}$. $(R_1, \\dots, R_n)$ is a **random permutation** under $H_0$.\n",
        "  \n",
        "- Hence, any deterministic function of the ranks and of the differences is a **pivotal test statistic**: it does not depend on the distribution of the data under $H_0$.\n",
        "\n",
        ":::\n",
        "\n",
        "## Wilcoxon's Signed Rank Test\n",
        "\n",
        "\n",
        ":::{.callout-note .fragment}\n",
        "## Properties on the Signed Ranks \n",
        "\n",
        "\n",
        "- Wilcoxon's test statistic:\n",
        "$W_- = \\sum_{i=1}^n R_i \\mathbf 1\\{D_i < 0\\}$\n",
        "- Sometimes, also $W_+ = \\sum_{i=1}^n R_i \\mathbf 1\\{D_i > 0\\}$ or $\\min(W_-, W_+)$.\n",
        "- Gaussian approximation: $W_- \\asymp n(n+1)/4 + \\sqrt{n(n+1)(2n+1)/24} \\mathcal N(0,1)$\n",
        "- if $H_1$: $\\mathrm{median}(D_i) > 0$: left-one sided test on $W_-$.\n",
        "\n",
        "\n",
        "\n",
        "\n",
        ":::\n",
        "\n",
        "This approximation fits well the exact distribution. Monte-Carlo simulation:\n",
        "\n",
        "![](../images/wilcoxon_W-.svg)\n",
        "\n",
        "\n",
        "To generate a $W_-$ under $H_0$ in Julia:\n",
        "```julia\n",
        "k = rand(Binomial(n, 0.5))\n",
        "w = sum(randperm(n)[1:k])\n",
        "```\n",
        "\n",
        "## Effect of Drug on Blood Pressure\n",
        "\n",
        "- $H_0$: the drug has no effect. $H_1$: it lowers the blood pressure\n",
        "\n",
        "\n",
        "\n",
        "| Patient | $X_i$ (Before) | $Y_i$​ (After) | $D_i = X_i-Y_i$​ | $R_i$ |\n",
        "| ------- | -------------- | -------------- | ---------------- | ----- |\n",
        "| 1       | 150            | 140            | 10               | 6 (+) |\n",
        "| 2       | 135            | 130            | 5                | 5 (+) |\n",
        "| 3       | 160            | 162            | -2               | 2 (-) |\n",
        "| 4       | 145            | 146            | -1               | 1 (-) |\n",
        "| 5       | 154            | 150            | 4                | 4 (+) |\n",
        "| 6       | 171            | 160            | 11               | 7 (+) |\n",
        "| 7       | 141            | 138            | 3                | 3 (+) |\n",
        "\n",
        "\n",
        "- $W_- = 1+2 = 3$.\n",
        "- From a simulation, we approx $\\mathbb P(W_-=i)$, for $i \\in \\{0, 1, 2, 3, 4, 5,6\\}$ under $H_0$ by\n"
      ],
      "id": "81d9f1af"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "[0.00784066, 0.00781442, 0.00781534, 0.01563892, 0.01562184, 0.02343478]"
      ],
      "id": "f40307bd",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "- From a simulation, $p_{value}=\\mathbb P(W_- \\leq 3) \\approx 0.039 < 0.05$"
      ],
      "id": "be0918f3"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "julia-1.10",
      "language": "julia",
      "display_name": "Julia 1.10.5",
      "path": "/home/ensai/.local/share/jupyter/kernels/julia-1.10"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}